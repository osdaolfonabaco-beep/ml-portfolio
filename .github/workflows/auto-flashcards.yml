name: Auto Flashcards Generator

on:
  push:
    paths:
      - 'foundations/python_advanced/**.py'
  workflow_dispatch:  # Allow manual triggering

jobs:
  generate-flashcards:
    runs-on: ubuntu-latest
    env:
      CI: true  # Mark environment as CI

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Create data directory
      run: mkdir -p data

    - name: Debug directory structure
      run: |
        echo "Current directory: $(pwd)"
        echo "Directory structure:"
        ls -la
        echo "Foundations directory:"
        ls -la foundations/python_advanced/ || echo "Foundations directory not found"
        echo "Tools directory:"
        ls -la tools/auto_study_engine/ || echo "Tools directory not found"

    - name: Run flashcard generator
      run: |
        echo "Running flashcard generator..."
        python tools/auto_study_engine/test_quiz.py
        echo "Exit code: $?"

    - name: Verify flashcard generation
      run: |
        echo "Checking if flashcards were generated..."
        if [ -f "data/mi_deck.json" ]; then
          echo "Flashcards generated successfully!"
          echo "File size: $(wc -c < data/mi_deck.json) bytes"
          echo "First 200 characters of file:"
          head -c 200 data/mi_deck.json
          echo ""
        else
          echo "ERROR: Flashcards were not generated!"
          echo "Contents of data directory:"
          ls -la data/ || echo "Data directory does not exist"
          exit 1
        fi

    - name: Commit generated flashcards
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/mi_deck.json
        git diff --cached --quiet || git commit -m "Auto-generate flashcards from code [skip ci]"
        git push