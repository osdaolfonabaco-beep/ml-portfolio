name: Auto Flashcards Generator

on:
  push:
    paths:
      - 'foundations/python_advanced/**.py'
  workflow_dispatch:

jobs:
  generate-flashcards:
    runs-on: ubuntu-latest
    env:
      CI: true

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Create directories
      run: |
        mkdir -p data
        mkdir -p foundations/python_advanced

    - name: Debug directory structure
      run: |
        echo "Current directory: $(pwd)"
        echo "Directory structure:"
        ls -la
        echo "Foundations directory:"
        ls -la foundations/ || echo "Foundations not found"
        echo "Python advanced directory:"
        ls -la foundations/python_advanced/ || echo "Python advanced not found"

    - name: Run flashcard generator with detailed logging
      run: |
        echo "Running flashcard generator..."
        python tools/auto_study_engine/test_quiz.py
        echo "Exit code: $?"
        echo "Current directory after execution: $(pwd)"
        echo "Data directory contents:"
        ls -la data/ || echo "Data directory doesn't exist"

    - name: Verify flashcard generation
      run: |
        echo "Checking if flashcards were generated..."
        if [ -f "data/mi_deck.json" ]; then
          echo "✅ Flashcards generated successfully!"
          echo "📊 File size: $(wc -c < data/mi_deck.json) bytes"
          echo "First few lines:"
          head -n 5 data/mi_deck.json
        else
          echo "❌ ERROR: mi_deck.json was not generated!"
          echo "Contents of current directory:"
          ls -la
          echo "Contents of data directory:"
          ls -la data/ || echo "Data directory doesn't exist"
          exit 1
        fi

    - name: Commit generated flashcards
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/mi_deck.json
        git diff --cached --quiet || git commit -m "Auto-generate flashcards from code [skip ci]"
        git push
        